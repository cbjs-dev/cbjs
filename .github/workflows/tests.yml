name: Tests
on:
  push:
    branches:
      - main
  issue_comment:
    types: [created]

jobs:
  test:
    if: >
      (github.event_name == 'push' && !contains(github.event.head_commit.message, 'skip ci')) ||
      (github.event.issue.pull_request && startsWith(github.event.comment.body, '/test') && github.actor == 'JesusTheHun')
    timeout-minutes: 20
    runs-on: ubuntu-latest
#    runs-on:
#      group: couchbase-runners
#      labels: ubuntu-latest-m
#    services:
#      couchbase:
#        image: couchbase
#        ports:
#          - 8091:8091
#          - 8092:8092
#          - 8093:8093
#          - 8096:8096
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm ci -ws --include-workspace-root

      - name: Build packages
        run: npm run build

      - name: Run all tests
        run: CB_CONNECTION_STRING=couchbase://couchbase npm run test -- --bail 5
